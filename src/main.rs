use bytes::Buf;
use std::error::Error;
use std::io::{copy, Read};
use filesize::PathExt;
use std::path::{Path, PathBuf};
use std::fs;

struct Document {
    _name: PathBuf,
    _content: Vec<u8>,
}

fn main() {
    println!("Welcome to the sussy malware ඞ \n");
    println!("ඞ ඞ ඞ ඞ ඞ ඞ ඞ ඞ ඞ \n>Please wait, making this folder sus....");

    match download_sus_imges() {
        Ok(()) => (println!(">Downloaded really sus images")),
        _ => {
            println!("Something is sus with your network, proceeding without downloading files.")
        }
    }

    let docs: Vec<Document> = match collect_files() {
        Ok(docs) => docs,
        Err(_error) => panic!("Something went wrong"),
    };

    for doc in docs {
        println!("{:?} {:?}", doc._name, doc._content)
    }
}

fn download_sus_imges() -> Result<(), Box<dyn Error>> {
    let images: Vec<&str> = vec![
        "https://i.redd.it/sqt01fync8381.jpg",
        "https://i.redd.it/oup944dz5mw51.jpg",
        "https://i.redd.it/zxynz9sgtgu51.jpg",
    ];

    let mut i = 0i32;
    for url in images {
        i = i + 1;
        let filename = format!("{}-{}", i.to_string(), "sus.jpg");
        let mut file = fs::File::create(filename)?;
        let mut content = reqwest::blocking::get(url)?.bytes()?.reader();
        copy(&mut content, &mut file)?;
    }
    Ok(())
}

fn collect_files() -> Result<Vec<Document>, Box<dyn Error>> {
    let mut documents: Vec<Document> = vec![];
    for entry in fs::read_dir(".")? {
        let _path_buf = entry?.path();
        let path = Path::new(&_path_buf);
        let ext = path.extension();
        if path.is_file() {
            let size = path.size_on_disk()?;
            if size < 800000 {
                if ext == None {
                    let mut file = fs::File::open(&_path_buf)?;
                    let mut data = Vec::new();
                    file.read_to_end(&mut data)?;
                    let doc = Document {
                        _name: _path_buf,
                        _content: data,
                    };
                    if documents.len() < 10 {
                        documents.push(doc);
                    }
                } else if ext.unwrap() != "jpg" {
                    let mut file = fs::File::open(&_path_buf)?;
                    let mut data = Vec::new();
                    file.read_to_end(&mut data)?;
                    let doc = Document {
                        _name: _path_buf,
                        _content: data,
                    };
                    if documents.len() < 10 {
                        documents.push(doc);
                    }
                }
            }
        }
    }
    Ok(documents)
}
